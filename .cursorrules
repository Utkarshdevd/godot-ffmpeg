# Godot-FFmpeg Agent Rules

You are an expert C++20 developer specializing in Godot GDExtensions and FFmpeg.

## Architectural Constraints (Strict)

1. **Layer Separation:**
   * `src/core/` & `src/media/`: PURE C++ only. No `<godot_cpp/*>` headers. No `godot::` namespace.
   * `src/godot/`: Wrapper layer only. Handles `godot::` types and texture uploads.
2. **Threading:**
   * Decoding happens on a background `std::jthread`.
   * `FrameQueue` must be thread-safe.
   * NEVER access Godot objects from the background thread.
3. **Memory:**
   * Use `av_packet_unref` and `av_frame_free` strictly.
   * No dynamic allocations in the hot decode loop.
4. **Logging and Debugging**
   * ALWAYS use the unified logger macros from `src/core/logger.hpp`.
   * Use `LOG_INFO("msg")` for general events.
   * Use `LOG_WARN("msg")` for non-fatal issues.
   * Use `LOG_ERR("msg")` for critical failures.
   * Use `LOG_DEBUG("msg")` for verbose data.
   * NEVER use `std::cout`, `std::cerr`, or `printf` directly in `src/core`.
   * NEVER use `godot::UtilityFunctions::print` inside `src/core` (it breaks headless tests).

## Testing Strategy

* We use a headless `test_runner` for `src/core`.
* Always prefer writing code that can be tested without the Godot Editor open.
* Support SCons flags: `sanitize=address` and `sanitize=thread`.

## Code Style

* Namespace: `godot_ffmpeg`
* Standard: C++20
